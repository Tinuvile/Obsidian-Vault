
## ğŸ“ å½“å‰RobustMQæ—¥å¿—ç°çŠ¶åˆ†æ

### **âœ… å·²æœ‰çš„æ—¥å¿—åŸºç¡€**

**æ—¥å¿—åº“ä½¿ç”¨ï¼š**
```rust
// RobustMQä½¿ç”¨ tracing ç”Ÿæ€ç³»ç»Ÿ
use tracing::{info, debug, error, warn};

// æ”¯æŒç»“æ„åŒ–æ—¥å¿—é…ç½®
src/common/base/src/logging/
â”œâ”€â”€ config.rs          # æ—¥å¿—é…ç½®ç®¡ç†
â”œâ”€â”€ mod.rs             # æ—¥å¿—åˆå§‹åŒ–
```

**æ—¥å¿—é…ç½®ç‰¹æ€§ï¼š**
```toml
# æ”¯æŒå¤šç§è¾“å‡ºæ–¹å¼
[appenders]
stdout = { kind = "Console", level = "Info" }
file = { 
    kind = "RollingFile", 
    level = "Debug", 
    rotation = "Daily",
    directory = "/var/logs",
    prefix = "robustmq" 
}
```

### **âŒ å­˜åœ¨çš„æ—¥å¿—æ ¼å¼é—®é¢˜**

ä»ä»£ç åˆ†æçœ‹ï¼Œç¡®å®å­˜åœ¨**æ—¥å¿—æ ¼å¼ä¸ç»Ÿä¸€**çš„é—®é¢˜ï¼š

#### **1. ä¿¡æ¯å¯†åº¦ä¸ä¸€è‡´**
```rust
// ç®€å•æ—¥å¿— - ç¼ºå°‘å…³é”®ä¸Šä¸‹æ–‡
info!("accept tcp connection:{:?}", addr);

// è¯¦ç»†æ—¥å¿— - åŒ…å«å®Œæ•´ä¸šåŠ¡ä¿¡æ¯  
info!("Exclusive push thread for client_id [{}], sub_path: [{}], topic_id [{}] was started successfully", 
      client_id, sub_path, topic_id);

// æ··ä¹±æ ¼å¼ - éš¾ä»¥è§£æ
info!("{}","No backpacking is required for this request");
```

#### **2. ç»“æ„åŒ–ç¨‹åº¦ä¸åŒ**
```rust
// éç»“æ„åŒ– - éš¾ä»¥æœºå™¨è§£æ
info!("connect [{}] login success", tcp_connection.connection_id);

// åŠç»“æ„åŒ– - éƒ¨åˆ†å¯è§£æ
info!("Received request from Placement center to delete expired Session. Cluster name :{}, clientId: {:?}", 
      req.cluster_name, req.client_id);

// åº”è¯¥æ˜¯ç»“æ„åŒ– - ä¾¿äºæŸ¥è¯¢å’Œèšåˆ
info!(
    action = "user_login",
    connection_id = %connection.connection_id,
    user = %user_name,
    result = "success",
    "User login successful"
);
```

#### **3. é”™è¯¯å¤„ç†æ ¼å¼æ··ä¹±**
```rust
// å„ç§é”™è¯¯æ ¼å¼
error!("TCP accept failed to create connection with error message :{:?}", e);
error!("Failed to write data to the request queue, error message: {:?}", err);
debug!("TCP connection parsing packet format error message :{:?}", e);
```

## ğŸš€ Fluent Bitæ˜¯ä»€ä¹ˆ

**Fluent Bit** = **è½»é‡çº§çš„æ—¥å¿—æ•°æ®æ”¶é›†å™¨å’Œè½¬å‘å™¨**ï¼Œæ˜¯äº‘åŸç”Ÿç¯å¢ƒä¸­çš„æ ‡å‡†æ—¥å¿—æ”¶é›†å·¥å…·ã€‚

### **æ—¥å¿—æ”¶é›†çš„æ•´ä½“æ¶æ„**

```
åº”ç”¨Podå†…éƒ¨      K8sé›†ç¾¤çº§åˆ«        å¤–éƒ¨å­˜å‚¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚åº”ç”¨è¿›ç¨‹      â”‚  â”‚Fluent Bit   â”‚   â”‚Elasticsearchâ”‚
â”‚             â”‚  â”‚DaemonSet    â”‚   â”‚Loki         â”‚
â”‚stdout/stderrâ”‚â”€â–¶â”‚             â”‚â”€â”€â–¶â”‚S3 Object    â”‚
â”‚æ–‡ä»¶æ—¥å¿—      â”‚  â”‚æ—¥å¿—èšåˆ      â”‚   â”‚Kafka        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚æ ¼å¼åŒ–å¤„ç†    â”‚   â”‚ç­‰ç­‰...       â”‚
                 â”‚æ ‡ç­¾å¢å¼º      â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **ä¸ºä»€ä¹ˆé€‰æ‹©Fluent Bitè€Œä¸æ˜¯Fluentd**

| ç‰¹æ€§ | Fluent Bit | Fluentd |
|------|------------|---------|
| **å†…å­˜å ç”¨** | ~1-3MB | ~20-50MB |
| **CPUä½¿ç”¨** | æä½ | ä¸­ç­‰ |
| **å¯åŠ¨é€Ÿåº¦** | æ¯«ç§’çº§ | ç§’çº§ |
| **æ’ä»¶æ•°é‡** | 100+ | 1000+ |
| **é€‚ç”¨åœºæ™¯** | **è¾¹ç¼˜/åµŒå…¥å¼/K8s** | å¤æ‚æ•°æ®å¤„ç† |

**K8sç¯å¢ƒä¼˜åŠ¿**ï¼š
- **DaemonSetæ¨¡å¼**ï¼šæ¯ä¸ªèŠ‚ç‚¹ä¸€ä¸ªFluent Bit Pod
- **èµ„æºæ¶ˆè€—ä½**ï¼šé€‚åˆå¤§è§„æ¨¡é›†ç¾¤
- **äº‘åŸç”Ÿä¼˜åŒ–**ï¼šåŸç”Ÿæ”¯æŒK8så…ƒæ•°æ®

## ğŸ”§ Fluent Bitåœ¨RobustMQä¸­çš„å®ç°æ–¹æ¡ˆ

### **1. DaemonSetéƒ¨ç½²é…ç½®**

```yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: fluent-bit
  namespace: robustmq-system
spec:
  selector:
    matchLabels:
      name: fluent-bit
  template:
    metadata:
      labels:
        name: fluent-bit
    spec:
      containers:
      - name: fluent-bit
        image: fluent/fluent-bit:2.2.0
        resources:
          limits:
            memory: 200Mi
          requests:
            cpu: 100m
            memory: 200Mi
        volumeMounts:
        - name: varlog
          mountPath: /var/log
        - name: varlibdockercontainers
          mountPath: /var/lib/docker/containers
          readOnly: true
        - name: fluent-bit-config
          mountPath: /fluent-bit/etc/
      volumes:
      - name: varlog
        hostPath:
          path: /var/log
      - name: varlibdockercontainers
        hostPath:
          path: /var/lib/docker/containers
      - name: fluent-bit-config
        configMap:
          name: fluent-bit-config
```

### **2. æ—¥å¿—æ”¶é›†é…ç½®**

```ini
# fluent-bit.conf
[SERVICE]
    Flush         1
    Log_Level     info
    Daemon        off
    Parsers_File  parsers.conf
    HTTP_Server   On
    HTTP_Listen   0.0.0.0
    HTTP_Port     2020

# ğŸ” æ”¶é›†RobustMQåº”ç”¨æ—¥å¿—
[INPUT]
    Name              tail
    Path              /var/log/containers/*robustmq*.log
    Parser            cri
    Tag               robustmq.*
    Refresh_Interval  5
    Mem_Buf_Limit     50MB

# ğŸ·ï¸ å¢å¼ºK8så…ƒæ•°æ®æ ‡ç­¾
[FILTER]
    Name                kubernetes
    Match               robustmq.*
    Kube_URL            https://kubernetes.default.svc:443
    Merge_Log           On
    Keep_Log            Off
    K8S-Logging.Parser  On
    K8S-Logging.Exclude On
    Annotations         Off
    Labels              On

# ğŸ“‹ è§£æRobustMQæ—¥å¿—æ ¼å¼
[FILTER]
    Name    parser
    Match   robustmq.*
    Key_Name log
    Parser  robustmq_parser
    Reserve_Data On

# ğŸ“¤ è¾“å‡ºåˆ°å¤šä¸ªç›®æ ‡
[OUTPUT]
    Name  es
    Match robustmq.*
    Host  elasticsearch.logging.svc.cluster.local
    Port  9200
    Index robustmq-logs
    
[OUTPUT]
    Name  prometheus_exporter
    Match robustmq.*
    Host  0.0.0.0
    Port  2021
```

### **3. RobustMQæ—¥å¿—æ ¼å¼æ ‡å‡†åŒ–**

**éœ€è¦åœ¨RobustMQä»£ç ä¸­å®ç°çš„æ”¹è¿›**ï¼š

```rust
// âŒ å½“å‰ä¸è§„èŒƒçš„æ ¼å¼
info!("accept tcp connection:{:?}", addr);

// âœ… æ”¹è¿›åçš„ç»“æ„åŒ–æ ¼å¼
info!(
    event = "connection_accepted",
    protocol = "tcp",
    remote_addr = %addr,
    connection_id = %connection_id,
    node_id = %broker_config.broker_id,
    "TCP connection accepted"
);

// âŒ å½“å‰é”™è¯¯æ—¥å¿—
error!("TCP accept failed to create connection with error message :{:?}", e);

// âœ… æ ‡å‡†åŒ–é”™è¯¯æ—¥å¿—
error!(
    event = "connection_failed", 
    protocol = "tcp",
    error_type = "accept_failed",
    error_msg = %e,
    node_id = %broker_config.broker_id,
    "Failed to accept TCP connection"
);
```

### **4. æ—¥å¿—åˆ†ç±»å’Œæ ‡ç­¾ç­–ç•¥**

```rust
// ä¸šåŠ¡æ—¥å¿—åˆ†ç±»
[Service Events]
â”œâ”€â”€ connection.*     # è¿æ¥ç›¸å…³: connection_accepted, connection_closed
â”œâ”€â”€ authentication.* # è®¤è¯ç›¸å…³: user_login, auth_failed
â”œâ”€â”€ message.*        # æ¶ˆæ¯ç›¸å…³: message_published, message_delivered
â”œâ”€â”€ subscription.*   # è®¢é˜…ç›¸å…³: topic_subscribed, subscription_cancelled
â”œâ”€â”€ cluster.*        # é›†ç¾¤ç›¸å…³: node_joined, leader_elected
â””â”€â”€ error.*          # é”™è¯¯ç›¸å…³: storage_error, network_error

[Technical Labels]
â”œâ”€â”€ node_id         # RobustMQèŠ‚ç‚¹ID
â”œâ”€â”€ service_type    # mqtt-broker, placement-center, journal-server
â”œâ”€â”€ protocol        # tcp, websocket, quic
â”œâ”€â”€ client_id       # MQTTå®¢æˆ·ç«¯ID
â””â”€â”€ topic_name      # ä¸»é¢˜åç§°
```

### **5. ç›‘æ§å’Œå‘Šè­¦é›†æˆ**

```yaml
# PrometheusæŒ‡æ ‡
robustmq_log_events_total{level="error", service="mqtt-broker", event="connection_failed"} 42
robustmq_log_events_total{level="warn", service="placement-center", event="node_unreachable"} 3

# å‘Šè­¦è§„åˆ™
groups:
- name: robustmq.logs
  rules:
  - alert: HighErrorRate
    expr: |
      (
        rate(robustmq_log_events_total{level="error"}[5m]) / 
        rate(robustmq_log_events_total[5m])
      ) > 0.01
    for: 2m
    annotations:
      summary: "RobustMQ error rate too high"
      description: "Error rate {{ $value }} in service {{ $labels.service }}"
```

## ğŸ¯ å®ç°ä¼˜å…ˆçº§

**Phase 1: æ—¥å¿—æ ‡å‡†åŒ–ï¼ˆ2å‘¨ï¼‰**
1. åˆ¶å®šæ—¥å¿—æ ¼å¼è§„èŒƒæ–‡æ¡£
2. é‡æ„æ ¸å¿ƒæ¨¡å—æ—¥å¿—ï¼ˆconnection, authentication, messageï¼‰
3. æ·»åŠ ç»Ÿä¸€çš„é”™è¯¯æ—¥å¿—æ ¼å¼

**Phase 2: Fluent Bité›†æˆï¼ˆ1å‘¨ï¼‰**  
1. åˆ›å»ºFluent Bit DaemonSeté…ç½®
2. é…ç½®æ—¥å¿—è§£æè§„åˆ™
3. é›†æˆåˆ°Helm Chart

**Phase 3: ç›‘æ§é›†æˆï¼ˆ1å‘¨ï¼‰**
1. æ—¥å¿—æŒ‡æ ‡å¯¼å‡ºåˆ°Prometheus
2. åˆ›å»ºGrafanaæ—¥å¿—é¢æ¿
3. é…ç½®å…³é”®æ—¥å¿—å‘Šè­¦

è¿™æ ·çš„æ—¥å¿—æ”¶é›†æ–¹æ¡ˆå°†å¤§å¤§æå‡RobustMQåœ¨ç”Ÿäº§ç¯å¢ƒä¸­çš„**å¯è§‚æµ‹æ€§**å’Œ**æ•…éšœæ’æŸ¥èƒ½åŠ›**ï¼
