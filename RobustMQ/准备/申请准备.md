## é¡¹ç›®ä¿¡æ¯ä»‹ç»

æœ¬é¡¹ç›®éœ€è¦ä¸º RobustMQ å®Œå–„å®‰å…¨ã€äº‘åŸç”Ÿéƒ¨ç½²ä¸¤ä¸ªéƒ¨åˆ†çš„å·¥ä½œï¼Œä»¥åŠéœ€è¦å®Œå–„å¯¹åº”çš„æµ‹è¯•ç”¨ä¾‹ï¼š

1. å®‰å…¨éƒ¨åˆ†ï¼šæŒ‡éœ€è¦å®Œå–„ RobustMQ MQTT çš„å®‰å…¨æ§åˆ¶éƒ¨åˆ†ï¼Œæ¯”å¦‚è®¤è¯ã€é‰´æƒã€SSLã€JWTã€Auth2.0 ç­‰ã€‚è¿™éƒ¨åˆ†å·¥ä½œæ˜¯ Rust å†…æ ¸çš„å¼€å‘å·¥ä½œã€‚ä¼šæ¶‰åŠåˆ°åˆ†å¸ƒå¼ç³»ç»Ÿçš„å®‰å…¨æ§åˆ¶çš„çŸ¥è¯†ç‚¹ã€‚
    
2. äº‘åŸç”Ÿéƒ¨ç½²ï¼šæŒ‡éœ€è¦å®Œå–„ RobustMQ çš„äº‘åŸç”Ÿéƒ¨ç½²ã€‚æ¯”å¦‚ Dockerfile çš„å®Œå–„ã€kubernetes operatorçš„å¼€å‘ç­‰ã€‚è¿™å—ä¸»è¦æ˜¯ K8s å’Œ Docker ç›¸å…³çš„çŸ¥è¯†ç‚¹ã€‚
    
3. æµ‹è¯•ç”¨ä¾‹å®Œå–„ï¼š éœ€è¦å®Œå–„å¯¹åº”çš„æµ‹è¯•ç”¨ä¾‹ã€‚

é¡¹ç›®æˆæœä»“åº“ï¼š[https://github.com/robustmq/robustmq](https://github.com/robustmq/robustmq)

---

## é¡¹ç›®å†…å®¹åˆ†æ

### MQTTçš„å®‰å…¨æ§åˆ¶éƒ¨åˆ†

#### ç°æœ‰ä»£ç åˆ†æ

ç›®å‰å·²ç»å®Œæ•´å®ç°çš„éƒ¨åˆ†åŒ…æ‹¬ï¼š
- âœ…æ˜æ–‡è®¤è¯ï¼ˆç”¨æˆ·ååŠ å¯†ç ï¼‰
å·²æœ‰ç©ºæ–‡ä»¶ç­‰å¾…å®ç°çš„éƒ¨åˆ†ï¼š
- ğŸ”§ JWTè®¤è¯
- ğŸ”§ X.509è¯ä¹¦è®¤è¯
- ğŸ”§ PSKè®¤è¯
- ğŸ”§ HTTPè®¤è¯
å®Œå…¨ç¼ºå¤±çš„éƒ¨åˆ†ï¼š
- âŒ SSL/TLSä¼ è¾“å±‚åŠ å¯†ï¼šéœ€è¦æ–°å¢
- âŒ OAuth 2.0ï¼šéœ€è¦æ–°å¢

MQTTå®‰å…¨æ§åˆ¶æµç¨‹å›¾ï¼š

![[Drawing 2025-06-03 21.06.27.excalidraw]]

è®¤è¯æ–¹å¼æµç¨‹å›¾

![[Drawing 2025-06-03 21.29.40.excalidraw]]

ACLæˆæƒå†³ç­–æµç¨‹å›¾

![[Drawing 2025-06-03 21.20.33.excalidraw]]

SSL/TLSå›¾

![[Drawing 2025-06-03 21.46.25.excalidraw]]


## ä¸€ã€Plaintext.rsä»£ç è¯¦ç»†è§£æ

### 1.1 ä»£ç ç»“æ„åˆ†æ

```rust
// 1. å¯¼å…¥ä¾èµ–
use std::sync::Arc;
use axum::async_trait;

use super::Authentication;  // å¼•ç”¨çˆ¶æ¨¡å—çš„Authentication trait
use crate::handler::cache::CacheManager;  // ç¼“å­˜ç®¡ç†å™¨
use crate::handler::error::MqttBrokerError;  // é”™è¯¯ç±»å‹
```

**è§£é‡Š**ï¼š
- `Arc<CacheManager>`ï¼šä½¿ç”¨åŸå­å¼•ç”¨è®¡æ•°æ™ºèƒ½æŒ‡é’ˆï¼Œæ”¯æŒå¤šçº¿ç¨‹å®‰å…¨çš„å…±äº«
- `async_trait`ï¼šä¸ºtraitæä¾›å¼‚æ­¥æ–¹æ³•æ”¯æŒï¼ˆRuståŸç”Ÿtraitä¸æ”¯æŒå¼‚æ­¥ï¼‰

### 1.2 æ ¸å¿ƒæ•°æ®ç»“æ„

```rust
pub struct Plaintext {
    username: String,           // ç”¨æˆ·å
    password: String,           // æ˜æ–‡å¯†ç 
    cache_manager: Arc<CacheManager>,  // ç¼“å­˜ç®¡ç†å™¨çš„å…±äº«å¼•ç”¨
}
```

**è®¾è®¡æ€è·¯**ï¼š
- **ç®€å•ç›´æ¥**ï¼šå­˜å‚¨ç”¨æˆ·åå’Œå¯†ç ï¼Œç”¨äºéªŒè¯
- **ç¼“å­˜ä¼˜åŒ–**ï¼šé€šè¿‡CacheManageré¿å…æ¯æ¬¡éƒ½æŸ¥è¯¢æ•°æ®åº“
- **çº¿ç¨‹å®‰å…¨**ï¼šä½¿ç”¨ArcåŒ…è£…ï¼Œæ”¯æŒå¤šçº¿ç¨‹å¹¶å‘è®¿é—®

### 1.3 æ„é€ å‡½æ•°

```rust
impl Plaintext {
    pub fn new(username: String, password: String, cache_manager: Arc<CacheManager>) -> Self {
        Plaintext {
            username,
            password,
            cache_manager,
        }
    }
}
```

**ç‰¹ç‚¹**ï¼š
- æ ‡å‡†çš„Rustæ„é€ å‡½æ•°æ¨¡å¼
- æ¥æ”¶æ‰€æœ‰æƒï¼ˆStringï¼‰è€Œä¸æ˜¯å€Ÿç”¨ï¼Œé¿å…ç”Ÿå‘½å‘¨æœŸå¤æ‚æ€§

### 1.4 è®¤è¯å®ç°

```rust
#[async_trait]
impl Authentication for Plaintext {
    async fn apply(&self) -> Result<bool, MqttBrokerError> {
        // ä»ç¼“å­˜ä¸­æŸ¥æ‰¾ç”¨æˆ·ä¿¡æ¯
        if let Some(user) = self.cache_manager.user_info.get(&self.username) {
            // ç›´æ¥æ¯”è¾ƒæ˜æ–‡å¯†ç ï¼ˆæ³¨æ„ï¼šè¿™åœ¨ç”Ÿäº§ç¯å¢ƒä¸­æ˜¯ä¸å®‰å…¨çš„ï¼‰
            return Ok(user.password == self.password);
        }
        // ç”¨æˆ·ä¸å­˜åœ¨
        return Err(MqttBrokerError::UserDoesNotExist);
    }
}
```

**å…³é”®é—®é¢˜åˆ†æ**ï¼š

1. **å®‰å…¨éšæ‚£**ï¼šå¯†ç æ˜æ–‡æ¯”è¾ƒï¼Œå­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š
   ```rust
   // å½“å‰å®ç°ï¼ˆä¸å®‰å…¨ï¼‰
   return Ok(user.password == self.password);
   
   // åº”è¯¥æ”¹ä¸ºï¼ˆå®‰å…¨ï¼‰
   return Ok(verify_password(&self.password, &user.password_hash));
   ```

2. **ç¼“å­˜ä¾èµ–**ï¼šå®Œå…¨ä¾èµ–ç¼“å­˜ï¼Œå¦‚æœç¼“å­˜å¤±æ•ˆå¯èƒ½å¯¼è‡´è®¤è¯å¤±è´¥

3. **é”™è¯¯å¤„ç†**ï¼šåªæœ‰ç”¨æˆ·ä¸å­˜åœ¨ä¸€ç§é”™è¯¯æƒ…å†µ

### 1.5 æµ‹è¯•ç”¨ä¾‹åˆ†æ

```rust
#[tokio::test]
pub async fn plaintext_test() {
    // 1. è®¾ç½®æµ‹è¯•ç¯å¢ƒ
    let conf = BrokerMqttConfig {
        cluster_name: "test".to_string(),
        ..Default::default()
    };
    let client_pool: Arc<ClientPool> = Arc::new(ClientPool::new(100));
    let cache_manager: Arc<CacheManager> = Arc::new(CacheManager::new(
        client_pool.clone(),
        conf.cluster_name.clone(),
    ));
    
    // 2. åˆ›å»ºæµ‹è¯•ç”¨æˆ·
    let username = "lobo".to_string();
    let password = "pwd123".to_string();
    let user = MqttUser {
        username: username.clone(),
        password: password.clone(),  // æ³¨æ„ï¼šè¿™é‡Œå­˜å‚¨çš„æ˜¯æ˜æ–‡å¯†ç 
        is_superuser: true,
    };
    cache_manager.add_user(user);  // æ·»åŠ åˆ°ç¼“å­˜
    
    // 3. æµ‹è¯•æ­£ç¡®å¯†ç 
    let pt = Plaintext::new(username.clone(), password.clone(), cache_manager.clone());
    let res = pt.apply().await.unwrap();
    assert!(res);  // åº”è¯¥è®¤è¯æˆåŠŸ
    
    // 4. æµ‹è¯•é”™è¯¯å¯†ç 
    let pt = Plaintext::new(username, "pwd1111".to_string(), cache_manager.clone());
    let res = pt.apply().await.unwrap();
    assert!(!res);  // åº”è¯¥è®¤è¯å¤±è´¥
}
```

**æµ‹è¯•è¦†ç›–åº¦**ï¼š
- âœ… æ­£ç¡®ç”¨æˆ·åå¯†ç 
- âœ… é”™è¯¯å¯†ç 
- âŒ ç¼ºå°‘ï¼šä¸å­˜åœ¨çš„ç”¨æˆ·åæµ‹è¯•
- âŒ ç¼ºå°‘ï¼šç©ºå¯†ç æµ‹è¯•
- âŒ ç¼ºå°‘ï¼šç‰¹æ®Šå­—ç¬¦æµ‹è¯•

## äºŒã€å®ŒæˆMQTTå®‰å…¨æ¨¡å—ä»»åŠ¡çš„èŒƒå›´åˆ†æ

åŸºäºä»£ç åˆ†æï¼Œ**å®ŒæˆMQTTå®‰å…¨æ¨¡å—ä»»åŠ¡ä¸ä»…ä»…éœ€è¦ä¿®æ”¹securityç›®å½•ï¼Œè¿˜éœ€è¦ä¿®æ”¹å…¶ä»–å¤šä¸ªæ¨¡å—**ï¼š

### 2.1 éœ€è¦ä¿®æ”¹çš„æ¨¡å—èŒƒå›´

#### âœ… **ä¸»è¦ä¿®æ”¹ï¼šsecurityç›®å½•**
```
src/mqtt-broker/src/security/
â”œâ”€â”€ login/
â”‚   â”œâ”€â”€ plaintext.rs     âœ… å·²å®Œæˆ
â”‚   â”œâ”€â”€ jwt.rs          ğŸ”§ éœ€è¦å®Œæ•´å®ç°
â”‚   â”œâ”€â”€ x509.rs         ğŸ”§ éœ€è¦å®Œæ•´å®ç°
â”‚   â”œâ”€â”€ psk.rs          ğŸ”§ éœ€è¦å®Œæ•´å®ç°
â”‚   â”œâ”€â”€ http.rs         ğŸ”§ éœ€è¦å®Œæ•´å®ç°
â”‚   â””â”€â”€ oauth2.rs       âŒ éœ€è¦æ–°å¢
â”œâ”€â”€ acl/                ğŸ”§ éœ€è¦å¢å¼ºACLåŠŸèƒ½
â””â”€â”€ mod.rs              ğŸ”§ éœ€è¦é›†æˆæ–°è®¤è¯æ–¹å¼
```

#### âœ… **ç½‘ç»œå±‚ä¿®æ”¹ï¼šserverç›®å½•**
```
src/mqtt-broker/src/server/tcp/
â”œâ”€â”€ tls_server.rs       ğŸ”§ éœ€è¦å¢å¼ºSSL/TLSåŠŸèƒ½
â”œâ”€â”€ tcp_server.rs       ğŸ”§ å¯èƒ½éœ€è¦åŒå‘è®¤è¯æ”¯æŒ
â””â”€â”€ handler.rs          ğŸ”§ éœ€è¦é›†æˆè®¤è¯æµç¨‹
```

#### âœ… **é…ç½®ç³»ç»Ÿä¿®æ”¹**
```
src/common/base/src/config/broker_mqtt.rs  ğŸ”§ éœ€è¦æ·»åŠ å®‰å…¨é…ç½®
config/                                   ğŸ”§ éœ€è¦æ·»åŠ è®¤è¯ç›¸å…³é…ç½®æ–‡ä»¶
```

#### âœ… **ä¾èµ–åº“ä¿®æ”¹**
```
Cargo.toml             ğŸ”§ éœ€è¦æ·»åŠ è®¤è¯ç›¸å…³ä¾èµ–ï¼š
                          - jsonwebtoken (JWT)
                          - oauth2 (OAuth 2.0)
                          - rustls (TLSå¢å¼º)
                          - x509-parser (è¯ä¹¦è§£æ)
```

### 2.2 å½“å‰TLSå®ç°åˆ†æ

ä»`tls_server.rs`ä»£ç å¯ä»¥çœ‹å‡ºï¼ŒRobustMQå·²ç»æœ‰äº†åŸºç¡€çš„**å•å‘TLS**å®ç°ï¼š

```rust
// å½“å‰åªæ”¯æŒå•å‘TLSè®¤è¯ï¼ˆæœåŠ¡å™¨è¯ä¹¦ï¼‰
let config = ServerConfig::builder()
    .with_no_client_auth()  // â† æ³¨æ„ï¼šæ²¡æœ‰å®¢æˆ·ç«¯è®¤è¯
    .with_single_cert(certs, key)
```

**éœ€è¦å¢å¼ºä¸ºåŒå‘TLS**ï¼š
```rust
// éœ€è¦æ”¹ä¸ºåŒå‘TLSè®¤è¯
let config = ServerConfig::builder()
    .with_client_cert_verifier(client_cert_verifier)  // â† éœ€è¦æ·»åŠ å®¢æˆ·ç«¯è¯ä¹¦éªŒè¯
    .with_single_cert(certs, key)
```

### 2.3 è®¤è¯é›†æˆç‚¹åˆ†æ

ä»`mqtt.rs`çš„`connect`æ–¹æ³•å¯ä»¥çœ‹åˆ°ï¼Œå½“å‰è®¤è¯é›†æˆç‚¹åœ¨ï¼š

```rust
// ç¬¬157-172è¡Œï¼šè®¤è¯æ£€æŸ¥ç‚¹
match self
    .auth_driver
    .check_login_auth(login, &connect_properties, &addr)  // â† è®¤è¯å…¥å£
    .await
{
    Ok(flag) => {
        if !flag {
            return response_packet_mqtt_connect_fail(
                &self.protocol,
                ConnectReturnCode::NotAuthorized,  // â† è®¤è¯å¤±è´¥å“åº”
                &connect_properties,
                None,
            );
        }
    }
    Err(e) => {
        return response_packet_mqtt_connect_fail(
            &self.protocol,
            ConnectReturnCode::UnspecifiedError,  // â† è®¤è¯é”™è¯¯å“åº”
            &connect_properties,
            Some(e.to_string()),
        );
    }
}
```

**å½“å‰è®¤è¯æµç¨‹é—®é¢˜**ï¼š
1. **åªæ”¯æŒæ˜æ–‡è®¤è¯**ï¼š`check_login_auth`ç›®å‰åªè°ƒç”¨`plaintext_check_login`
2. **ç¼ºå°‘è®¤è¯æ–¹å¼é€‰æ‹©**ï¼šéœ€è¦æ ¹æ®è¿æ¥å‚æ•°é€‰æ‹©ä¸åŒè®¤è¯æ–¹å¼
3. **ç¼ºå°‘è¯ä¹¦è®¤è¯é›†æˆ**ï¼šTLSæ¡æ‰‹ä¸­çš„è¯ä¹¦ä¿¡æ¯æ²¡æœ‰ä¼ é€’åˆ°è®¤è¯å±‚

## ä¸‰ã€å®Œæ•´çš„ä»»åŠ¡å®æ–½èŒƒå›´

ç»¼ä¸Šæ‰€è¿°ï¼Œå®ŒæˆMQTTå®‰å…¨æ¨¡å—éœ€è¦ä¿®æ”¹çš„å®Œæ•´èŒƒå›´æ˜¯ï¼š

### 3.1 æ ¸å¿ƒå®ç°ï¼ˆsecurityç›®å½•ï¼‰
- å®ç°JWTã€X.509ã€PSKã€HTTPã€OAuth2.0è®¤è¯æ–¹å¼
- å¢å¼ºACLæˆæƒåŠŸèƒ½
- å®Œå–„è®¤è¯é©±åŠ¨å™¨

### 3.2 ç½‘ç»œå±‚é›†æˆï¼ˆserverç›®å½•ï¼‰  
- å¢å¼ºTLSåŒå‘è®¤è¯
- è¯ä¹¦ä¿¡æ¯ä¼ é€’åˆ°è®¤è¯å±‚
- æ·»åŠ SASLåè®®æ”¯æŒ

### 3.3 é…ç½®ç³»ç»Ÿï¼ˆconfigç›®å½•ï¼‰
- æ·»åŠ å„ç§è®¤è¯æ–¹å¼çš„é…ç½®
- SSL/TLSè¯ä¹¦é…ç½®å¢å¼º

### 3.4 æµ‹è¯•ç”¨ä¾‹ï¼ˆtestsç›®å½•ï¼‰
- å„è®¤è¯æ–¹å¼çš„å•å…ƒæµ‹è¯•
- é›†æˆæµ‹è¯•
- å®‰å…¨æµ‹è¯•

å› æ­¤ï¼Œ**ä¸ä»…ä»…æ˜¯ä¿®æ”¹securityç›®å½•ï¼Œè€Œæ˜¯ä¸€ä¸ªæ¶‰åŠå¤šä¸ªæ¨¡å—çš„ç³»ç»Ÿæ€§æ”¹è¿›å·¥ç¨‹**ã€‚

---

## 1. è®¤è¯é©±åŠ¨å™¨åº”è¯¥åœ¨å“ªé‡Œå®ç°ï¼Ÿ

### å½“å‰è®¤è¯é©±åŠ¨å™¨æ¶æ„

**è®¤è¯é©±åŠ¨å™¨å·²ç»åœ¨ `src/mqtt-broker/src/security/mod.rs` ä¸­å®ç°**ï¼Œé‡‡ç”¨äº†åˆ†å±‚æ¶æ„ï¼š

```rust
// è®¤è¯é©±åŠ¨å™¨ä¸»ç»“æ„
pub struct AuthDriver {
    cache_manager: Arc<CacheManager>,
    client_pool: Arc<ClientPool>, 
    driver: Arc<dyn AuthStorageAdapter + Send + 'static + Sync>,  // å­˜å‚¨é€‚é…å™¨
}
```

### æ¶æ„åˆ†æ

```
è®¤è¯é©±åŠ¨å™¨æ¶æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        AuthDriver              â”‚  â† ä¸»è¦è®¤è¯é©±åŠ¨å™¨ (mod.rs)
â”‚  - check_login_auth()          â”‚
â”‚  - allow_connect()             â”‚
â”‚  - allow_publish()             â”‚
â”‚  - allow_subscribe()           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   AuthStorageAdapter (trait)   â”‚  â† å­˜å‚¨æŠ½è±¡å±‚
â”‚  - read_all_user()             â”‚
â”‚  - save_user()                 â”‚
â”‚  - read_all_acl()              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
â”‚ Placement  â”‚        â”‚   MySQL    â”‚  â† å…·ä½“å­˜å‚¨å®ç°
â”‚ Adapter    â”‚        â”‚  Adapter   â”‚    (storage/ ç›®å½•)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è®¤è¯æ–¹å¼é›†æˆç‚¹

**éœ€è¦å¢å¼ºçš„åœ°æ–¹**ï¼šå½“å‰ `check_login_auth` æ–¹æ³•åªæ”¯æŒæ˜æ–‡è®¤è¯ï¼Œéœ€è¦æ‰©å±•ä¸ºï¼š

```rust
// å½“å‰å®ç°ï¼ˆä»…æ˜æ–‡ï¼‰
pub async fn check_login_auth(&self, login: &Option<Login>, ...) -> Result<bool, MqttBrokerError> {
    if let Some(info) = login {
        return self.plaintext_check_login(&info.username, &info.password).await;
    }
    Ok(false)
}

// éœ€è¦æ”¹ä¸ºï¼ˆæ”¯æŒå¤šç§è®¤è¯ï¼‰
pub async fn check_login_auth(
    &self, 
    login: &Option<Login>,
    connect_properties: &Option<ConnectProperties>,
    addr: &SocketAddr,
    client_cert: &Option<Certificate>,  // æ–°å¢ï¼šå®¢æˆ·ç«¯è¯ä¹¦
) -> Result<bool, MqttBrokerError> {
    // æ ¹æ®è¿æ¥ä¿¡æ¯é€‰æ‹©è®¤è¯æ–¹å¼
    let auth_method = self.determine_auth_method(login, connect_properties, client_cert);
    
    match auth_method {
        AuthMethod::Plaintext => self.plaintext_check_login(...).await,
        AuthMethod::JWT => self.jwt_check_login(...).await,
        AuthMethod::X509 => self.x509_check_login(...).await,
        AuthMethod::PSK => self.psk_check_login(...).await,
        AuthMethod::HTTP => self.http_check_login(...).await,
        AuthMethod::OAuth2 => self.oauth2_check_login(...).await,
    }
}
```

## 2. SASLåè®®æ”¯æŒæ˜¯ä»€ä¹ˆï¼Ÿ

### SASLç®€ä»‹

**SASLï¼ˆSimple Authentication and Security Layerï¼‰** æ˜¯ä¸€ä¸ªè®¤è¯æ¡†æ¶ï¼Œä¸ºç½‘ç»œåè®®æä¾›è®¤è¯å’Œæ•°æ®å®‰å…¨æœåŠ¡ã€‚

### SASLåœ¨MQTTä¸­çš„åº”ç”¨

```
SASLè®¤è¯æµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    1. CONNECT     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚MQTT Client  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚MQTT Broker  â”‚
â”‚             â”‚                   â”‚             â”‚
â”‚             â”‚    2. AUTH        â”‚             â”‚
â”‚             â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚             â”‚
â”‚             â”‚  (SASL Challenge) â”‚             â”‚
â”‚             â”‚                   â”‚             â”‚
â”‚             â”‚    3. AUTH        â”‚             â”‚
â”‚             â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚             â”‚
â”‚             â”‚  (SASL Response)  â”‚             â”‚
â”‚             â”‚                   â”‚             â”‚
â”‚             â”‚    4. CONNACK     â”‚             â”‚
â”‚             â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    (Success)      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### SASLæœºåˆ¶ç±»å‹

**å¸¸è§çš„SASLæœºåˆ¶**ï¼š

1. **SASL/PLAIN**ï¼šæ˜æ–‡ç”¨æˆ·åå¯†ç 
```rust
// MQTT CONNECTåŒ…ä¸­çš„ç”¨æˆ·åå¯†ç å°±æ˜¯SASL/PLAIN
struct SaslPlain {
    authzid: String,  // æˆæƒID
    authcid: String,  // è®¤è¯IDï¼ˆç”¨æˆ·åï¼‰
    passwd: String,   // å¯†ç 
}
```

2. **SASL/SCRAM-SHA-256**ï¼šåŸºäºæŒ‘æˆ˜-å“åº”çš„å®‰å…¨è®¤è¯
```rust
// æœåŠ¡å™¨å‘é€æŒ‘æˆ˜ï¼Œå®¢æˆ·ç«¯è®¡ç®—å“åº”
struct SaslScram {
    client_nonce: String,
    server_nonce: String,
    salt: String,
    iteration_count: u32,
}
```

3. **SASL/GSSAPI (Kerberos)**ï¼šåŸºäºKerberosç¥¨æ®
4. **SASL/EXTERNAL**ï¼šåŸºäºå¤–éƒ¨è®¤è¯ï¼ˆå¦‚X.509è¯ä¹¦ï¼‰

### åœ¨RobustMQä¸­å®ç°SASL

**éœ€è¦åœ¨ä»¥ä¸‹ä½ç½®å®ç°SASLæ”¯æŒ**ï¼š

```
src/mqtt-broker/src/security/
â”œâ”€â”€ sasl/                    â† æ–°å¢SASLæ¨¡å—
â”‚   â”œâ”€â”€ mod.rs              
â”‚   â”œâ”€â”€ plain.rs            â† SASL/PLAINå®ç°
â”‚   â”œâ”€â”€ scram.rs            â† SASL/SCRAMå®ç°  
â”‚   â”œâ”€â”€ external.rs         â† SASL/EXTERNALå®ç°
â”‚   â””â”€â”€ gssapi.rs           â† SASL/GSSAPIå®ç°
â””â”€â”€ mod.rs                  â† é›†æˆSASLè®¤è¯
```

**åè®®å±‚ä¿®æ”¹**ï¼š
```
src/protocol/src/mqtt/
â”œâ”€â”€ common.rs               â† æ·»åŠ AUTHåŒ…ç±»å‹
â””â”€â”€ mqttv5/
    â”œâ”€â”€ auth.rs             â† æ–°å¢ï¼šMQTTv5 AUTHåŒ…å¤„ç†
    â””â”€â”€ connect.rs          â† ä¿®æ”¹ï¼šæ”¯æŒSASLå‚æ•°
```

## 3. configç›®å½•åœ¨å“ªé‡Œï¼Ÿ

### configç›®å½•ä½ç½®

**configç›®å½•åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹**ï¼š`./config/`

Ran tool

Ran tool
### å½“å‰é…ç½®ç»“æ„

```
config/
â”œâ”€â”€ mqtt-server.toml           â† ä¸»è¦MQTTæœåŠ¡å™¨é…ç½®
â”œâ”€â”€ journal-server.toml        â† æ—¥å¿—æœåŠ¡å™¨é…ç½®  
â”œâ”€â”€ placement-center.toml      â† æ”¾ç½®ä¸­å¿ƒé…ç½®
â”œâ”€â”€ example/                   â† é…ç½®ç¤ºä¾‹
â”‚   â”œâ”€â”€ certs/                â† TLSè¯ä¹¦ç›®å½•ï¼ˆç©ºï¼‰
â”‚   â”œâ”€â”€ mqtt-server.toml.example
â”‚   â””â”€â”€ log4rs.yaml.example
â””â”€â”€ log-config/               â† æ—¥å¿—é…ç½®
    â””â”€â”€ ...
```

### å½“å‰å®‰å…¨é…ç½®åˆ†æ

ä» `mqtt-server.toml` å¯ä»¥çœ‹å‡ºï¼Œå½“å‰çš„å®‰å…¨é…ç½®éå¸¸ç®€å•ï¼š

```toml
[auth]
storage_type = "placement"     # ä»…é…ç½®å­˜å‚¨ç±»å‹

[network]
tls_cert = "./config/example/certs/cert.pem"    # TLSè¯ä¹¦è·¯å¾„
tls_key = "./config/example/certs/key.pem"      # TLSç§é’¥è·¯å¾„
```

### éœ€è¦å¢å¼ºçš„å®‰å…¨é…ç½®

**éœ€è¦æ·»åŠ çš„é…ç½®æ®µ**ï¼š

```toml
[auth]
storage_type = "placement"
enable_methods = ["plaintext", "jwt", "x509", "psk", "http", "oauth2"]  # å¯ç”¨çš„è®¤è¯æ–¹å¼

# JWTè®¤è¯é…ç½®
[auth.jwt]
secret_key = "your-secret-key"
issuer = "robustmq"
expiration_minutes = 60
algorithm = "HS256"

# X.509è¯ä¹¦è®¤è¯é…ç½®  
[auth.x509]
ca_cert_path = "./config/certs/ca.pem"
client_cert_verification = true
crl_check = true

# PSKè®¤è¯é…ç½®
[auth.psk]
key_store_path = "./config/psk/keys.toml"

# HTTPè®¤è¯é…ç½®
[auth.http]
auth_endpoint = "http://localhost:8080/auth"
timeout_ms = 5000

# OAuth2é…ç½®
[auth.oauth2]
authorization_server = "https://oauth.example.com"
client_id = "robustmq-client"
client_secret = "secret"
token_endpoint = "https://oauth.example.com/token"

# SASLé…ç½®
[auth.sasl]
enable_plain = true
enable_scram_sha256 = true
enable_external = true
enable_gssapi = false

# TLSå¢å¼ºé…ç½®
[network.tls]
cert_file = "./config/certs/server.pem"
key_file = "./config/certs/server-key.pem"
ca_file = "./config/certs/ca.pem"
verify_client = true
verify_hostname = false
```

### æ€»ç»“

1. **è®¤è¯é©±åŠ¨å™¨**ï¼šå·²åœ¨ `src/mqtt-broker/src/security/mod.rs` å®ç°ï¼Œéœ€è¦å¢å¼ºå¤šç§è®¤è¯æ–¹å¼æ”¯æŒ
2. **SASLåè®®**ï¼šæ˜¯è®¤è¯æ¡†æ¶ï¼Œéœ€è¦åœ¨securityæ¨¡å—æ–°å¢saslå­æ¨¡å—ï¼Œå¹¶ä¿®æ”¹åè®®å±‚
3. **configç›®å½•**ï¼šåœ¨é¡¹ç›®æ ¹ç›®å½• `./config/`ï¼Œéœ€è¦å¤§å¹…å¢å¼ºå®‰å…¨ç›¸å…³é…ç½®
