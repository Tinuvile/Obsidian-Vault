# Isolation & system call entry/exit

---

è¿™ä¸€èŠ‚çš„ç¬”è®°å†™çš„æœ‰ç‚¹ä¹±ï¼ŒChapter4ä¼šå¥½ä¸€äº›

---

## Trapæœºåˆ¶

ç¨‹åºè¿è¡Œæ—¶ä¼šå‘ç”Ÿç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´çš„åˆ‡æ¢ï¼Œæ¯å½“ï¼š

- ç¨‹åºæ‰§è¡Œç³»ç»Ÿè°ƒç”¨ï¼›

- ç¨‹åºå‡ºç°ç±»ä¼¼`page fault`ã€è¿ç®—é™¤ä»¥é›¶çš„é”™è¯¯ï¼›

- ä¸€ä¸ªè®¾å¤‡è§¦å‘äº†ä¸­æ–­ä½¿å¾—å½“å‰ç¨‹åºè¿è¡Œéœ€è¦å“åº”å†…æ ¸è®¾å¤‡é©±åŠ¨

éƒ½ä¼šå‘ç”Ÿåˆ‡æ¢ã€‚æˆ‘ä»¬æŠŠè¿™é‡Œç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´çš„åˆ‡æ¢ç§°ä¸º`trap`ã€‚

RISC-Væœ‰32ä¸ªç”¨æˆ·å¯„å­˜å™¨ã€‚å…¶ä¸­éœ€è¦å…³æ³¨çš„æœ‰ï¼š

- å †æ ˆå¯„å­˜å™¨**Stack Pointer**

- ç¨‹åºè®¡æ•°å™¨**Program Counter Register**

- å¯„å­˜å™¨ä¸­è¡¨æ˜å½“å‰`mode`çš„æ ‡å¿—ä½

- SATPå¯„å­˜å™¨**Supervisor Address Translation and Protection**

- STVECå¯„å­˜å™¨**Supervisor Trap Vector Base Address Register**

- SEPCå¯„å­˜å™¨**Supervisor Exception Program Counter**

- SSRATCHå¯„å­˜å™¨**Supervisor Scratch Register**

åœ¨`trap`æœ€å¼€å§‹çš„æ—¶å€™ï¼ŒCPUå¤„äº`user mode`ï¼Œå› æ­¤æˆ‘ä»¬è¦æ”¹ä¸€äº›çŠ¶æ€æ‰å¯ä»¥è¿è¡Œç³»ç»Ÿå†…æ ¸ä¸­çš„ä»£ç ï¼š

1. é¦–å…ˆï¼Œéœ€è¦ä¿å­˜32ä¸ªç”¨æˆ·å¯„å­˜å™¨ï¼Œå› ä¸ºåé¢éœ€è¦æ¢å¤ç”¨æˆ·åº”ç”¨ç¨‹åºçš„æ‰§è¡Œï¼›

2. ç¨‹åºè®¡æ•°å™¨åŒæ ·éœ€è¦è¢«ä¿å­˜ï¼›

3. ç„¶åå°†`mode`æ”¹ä¸º`supervisor mode`ï¼›

4. ä¿®æ”¹SATPå¯„å­˜å™¨æŒ‡å‘ï¼ŒåŸå…ˆæŒ‡å‘çš„æ˜¯`user page table`ï¼Œéœ€è¦è½¬å‘`kernel page table`ï¼›

5. éœ€è¦å°†å †æ ˆå¯„å­˜å™¨æŒ‡å‘ä½äºå†…æ ¸çš„ä¸€ä¸ªåœ°å€ï¼Œæˆ‘ä»¬åˆ©ç”¨å®ƒæ¥è°ƒç”¨å†…æ ¸çš„å‡½æ•°ä»£ç ï¼›

6. è®¾ç½®å®Œæˆåè¿›å…¥å†…æ ¸ä»£ç ã€‚

æˆ‘ä»¬ä»ç„¶å¸Œæœ›ä¿æŒè‰¯å¥½çš„éš”ç¦»æ€§ï¼Œå› æ­¤`trap`ä¸­æ¶‰åŠåˆ°çš„ç¡¬ä»¶å’Œå†…æ ¸æœºåˆ¶ä¸èƒ½ä¾èµ–ä»»ä½•æ¥è‡ªç”¨æˆ·ç©ºé—´çš„ä¸œè¥¿ã€‚

> é¢å¤–è¯´æ˜ä¸€ä¸‹`mode`æ ‡å¿—ä½å¯„å­˜å™¨ï¼šä»`user mode`åˆ‡æ¢åˆ°`supervisor mode`åï¼Œå®é™…ä¸Šåªèƒ½å¤šåšä¸¤ä»¶äº‹ã€‚ä¸€æ˜¯å¯ä»¥è¯»å†™æ§åˆ¶å¯„å­˜å™¨ï¼Œå³ä¸Šé¢æåˆ°çš„é‚£äº›å¯„å­˜å™¨ï¼›äºŒæ˜¯å¯ä»¥ä½¿ç”¨`PTE_U`æ ‡å¿—ä½ä¸º0çš„`PTE`ã€‚ä½†æ­¤æ¨¡å¼ä»ç„¶ä¸èƒ½è¯»å†™ä»»æ„ç‰©ç†åœ°å€ï¼Œå®ƒåŒæ ·å—é™äºå½“å‰`page table`è®¾ç½®çš„è™šæ‹Ÿåœ°å€ã€‚

---

## Trapä»£ç æ‰§è¡Œæµç¨‹

æˆ‘ä»¬ä»¥`Shell`ä¸­è°ƒç”¨`write`ç³»ç»Ÿè°ƒç”¨ä¸ºä¾‹ã€‚è¿™é€šè¿‡æ‰§è¡Œ`ecall`æŒ‡ä»¤æ¥æ‰§è¡Œã€‚`ecall`æŒ‡ä»¤ä¼šåˆ‡æ¢åˆ°`supervisor mode`çš„å†…æ ¸ä¸­ã€‚ç„¶åå†…æ ¸ä¼šæ‰§è¡Œ`uservec`ï¼Œè¿™æ˜¯ä¸€ä¸ªç”±æ±‡ç¼–è¯­è¨€å†™çš„å‡½æ•°ï¼Œä½äº`trampoline.S`ä¸­ï¼›åœ¨è¿™ä¸ªæ±‡ç¼–å‡½æ•°ä¸­ï¼Œä»£ç æ‰§è¡Œä¼šè·³è½¬åˆ°`usertrap`ï¼Œè¿™ä¸ªå‡½æ•°åœ¨`trap.c`ä¸­ï¼›åœ¨`usertrap`ä¸­ï¼Œä¼šæ‰§è¡Œä¸€ä¸ªå«åš`syscall`çš„å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°åœ¨ä¸€ä¸ªè¡¨å•ä¸­æ ¹æ®ä¼ å…¥çš„æ•°å­—æŸ¥æ‰¾å·²ç»å®ç°çš„å¯¹åº”çš„ç³»ç»Ÿè°ƒç”¨å‡½æ•°ï¼Œå¯¹äºæœ¬ä¾‹æ˜¯`sys_write`ï¼›`syswrite`ä¼šå°†è¦æ˜¾ç¤ºçš„æ•°æ®è¾“å‡ºåˆ°`console`ä¸Šï¼Œå®Œæˆåè¿”å›ç»™`syscall`ã€‚

ä¸Šè¿°æ‰§è¡Œæµç¨‹ç›¸å½“äºåœ¨`ecall`å¤„å°±ä¸­æ–­äº†ç”¨æˆ·ä»£ç çš„æ‰§è¡Œï¼Œç„¶åæˆ‘ä»¬éœ€è¦æ¢å¤å®ƒã€‚

`syscall`å‡½æ•°ä¼šè°ƒç”¨`usertrapret`å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ä¼šå®Œæˆæ–¹ä¾¿åœ¨Cä»£ç ä¸­å®ç°çš„è¿”å›ç”¨æˆ·ç©ºé—´æ“ä½œï¼›ç„¶åå†è¿è¡Œ`userret`å‡½æ•°ï¼Œå®Œæˆåªèƒ½åœ¨æ±‡ç¼–è¯­è¨€ä¸­å®Œæˆçš„æ“ä½œï¼›æœ€ç»ˆï¼Œè¿™ä¸ªæ±‡ç¼–å‡½æ•°ä¼šè°ƒç”¨æœºå™¨æŒ‡ä»¤è¿”å›ç”¨æˆ·ç©ºé—´ï¼Œå¹¶æ¢å¤ç”¨æˆ·ç¨‹åºçš„æ‰§è¡Œã€‚

---

## ECALLæŒ‡ä»¤ä¹‹å‰çš„çŠ¶æ€

æ¥ä¸‹æ¥ä½¿ç”¨**gdb**æ¥è·Ÿè¸ª`write`ç³»ç»Ÿè°ƒç”¨ï¼Œæˆ‘ä»¬è·Ÿè¸ª`Shell`å°†æç¤ºä¿¡æ¯é€šè¿‡`write`ç³»ç»Ÿè°ƒç”¨èµ°åˆ°æ“ä½œç³»ç»Ÿå†èµ°åˆ°`console`çš„è¿‡ç¨‹ã€‚

```c
int
getcmd(char *buf, int nbuf)
{
  write(2, "$ ", 2);
  memset(buf, 0, nbuf);
  gets(buf, nbuf);
  if(buf[0] == 0) // EOF
    return -1;
  return 0;
}
```

ä¸Šé¢`write(2, "$", 2)`å°†`"$"`å†™å…¥åˆ°æ–‡ä»¶æè¿°ç¬¦`2`ã€‚æ¥ä¸‹æ¥æ‰“å¼€`gdb`ï¼š

```bash
tinuvile@LAPTOP-7PVP3HH3:~/xv6-labs-2024$ make qemu-gdb
*** Now run 'gdb' in another window.
qemu-system-riscv64 -machine virt -bios none -kernel kernel/kernel -m 128M -smp 3 -nographic -global virtio-mmio.force-legacy=false -drive file=fs.img,if=none,format=raw,id=x0 -device virtio-blk-device,drive=x0,bus=virtio-mmio-bus.0 -S -gdb tcp::26000
```

ç„¶åï¼š

```bash
tinuvile@LAPTOP-7PVP3HH3:~/xv6-labs-2024$ gdb-multiarch -q -ex "file kernel/kernel" -ex "set architecture riscv:rv64" -ex "target remote :26000"
warning: File "/home/tinuvile/xv6-labs-2024/.gdbinit" auto-loading has been declined by your `auto-load safe-path' set to "$debugdir:$datadir/auto-load".
To enable execution of this file add
        add-auto-load-safe-path /home/tinuvile/xv6-labs-2024/.gdbinit
line to your configuration file "/home/tinuvile/.gdbinit".
To completely disable this security protection add
        set auto-load safe-path /
line to your configuration file "/home/tinuvile/.gdbinit".
For more information about this security protection see the
"Auto-loading safe path" section in the GDB manual.  E.g., run from the shell:
        info "(gdb)Auto-loading safe path"
Reading symbols from kernel/kernel...
The target architecture is set to "riscv:rv64".
Remote debugging using :26000
warning: Architecture rejected target-supplied description
0x0000000000001000 in ?? ()
```

å½“`Shell`è°ƒç”¨`write`æ—¶ï¼Œå®é™…è°ƒç”¨çš„æ˜¯å…³è”åˆ°`Shell`çš„ä¸€ä¸ªåº“å‡½æ•°ï¼Œä½äº`usys.S`ä¸­ï¼š

```asm6502
.global write
write:
 li a7, SYS_write
 ecall
 ret
```

å®ƒå°†`SYS_write`åŠ è½½åˆ°`a7`å¯„å­˜å™¨ä¸­ï¼Œ`SYS_write`æ˜¯å¯¹åº”æ•°å­—16ï¼›ç„¶åæ‰§è¡Œ`ecall`æŒ‡ä»¤ï¼Œä»£ç æ‰§è¡Œè·³è½¬åˆ°å†…æ ¸ï¼›æ‰§è¡Œå®Œåè¿”å›ç”¨æˆ·ç©ºé—´ï¼Œæ‰§è¡Œ`ret`ï¼Œè¿”å›`Shell`ä¸­ã€‚

é€šè¿‡æŸ¥çœ‹`xv6`ç¼–è¯‘äº§ç”Ÿçš„`sh.asm`å¯»æ‰¾`ecall`æŒ‡ä»¤çš„åœ°å€ï¼š

```asm6502
0000000000000c12 <write>:
.global write
write:
 li a7, SYS_write
     c12:    48c1                    li    a7,16
 ecall
     c14:    00000073              ecall
 ret
     c18:    8082                    ret
```

åœ¨`ecall`æŒ‡ä»¤å¤„è®¾ç½®æ–­ç‚¹ï¼Œæ£€æŸ¥`pc`ç¡®è®¤ä¸€ä¸‹ï¼Œç„¶åæ‰“å°å…¨éƒ¨32ä¸ªç”¨æˆ·å¯„å­˜å™¨ï¼š

```bash
(gdb) b *0xc12
Breakpoint 1 at 0xc12
(gdb) c
Continuing.
[Switching to Thread 1.3]

Thread 3 hit Breakpoint 1, 0x0000000000000c12 in ?? ()
(gdb) delete 1
(gdb) print $pc
$1 = (void (*)()) 0xc12
(gdb) info reg
ra             0x20     0x20
sp             0x4f70   0x4f70
gp             0x0      0x0
tp             0x0      0x0
t0             0x0      0
t1             0x0      0
t2             0x0      0
fp             0x4f90   0x4f90
s1             0x2020   8224
a0             0x2      2
a1             0x11a0   4512
a2             0x2      2
a3             0x0      0
a4             0x12     18
a5             0x2      2
a6             0x0      0
a7             0x15     21
s2             0x64     100
s3             0x20     32
s4             0x2023   8227
s5             0x12a0   4768
s6             0x0      0
s7             0x0      0
s8             0x0      0
s9             0x0      0
s10            0x0      0
s11            0x0      0
t3             0x0      0
t4             0x0      0
--Type <RET> for more, q to quit, c to continue without paging--q
Quit
```

å…¶ä¸­`a0`ã€`a1`ã€`a2`æ˜¯`Shell`ä¼ é€’ç»™`write`ç³»ç»Ÿè°ƒç”¨çš„å‚æ•°ã€‚`a0`æ˜¯æ–‡ä»¶æè¿°ç¬¦ï¼Œ`a1`æ˜¯`Shell`æƒ³å†™å…¥å­—ç¬¦ä¸²çš„æŒ‡é’ˆï¼Œ`a2`æ˜¯æƒ³å†™å…¥çš„å­—ç¬¦æ•°ã€‚

```bash
(gdb) x/2c $a1
0x11a0: 36 '$'  32 ' '
```

å¦å¤–ï¼Œä¸Šå›¾å¯„å­˜å™¨ä¸­`pc`å’Œ`sp`çš„åœ°å€éƒ½åœ¨è·ç¦»0æ¯”è¾ƒä»…çš„åœ°å€ï¼Œè¿™ä¹Ÿå¯ä»¥è¿›ä¸€æ­¥å°è¯å½“å‰ä»£ç è¿è¡Œåœ¨ç”¨æˆ·ç©ºé—´ä¸­ã€‚å› ä¸ºç”¨æˆ·ç©ºé—´ä¸­æ‰€æœ‰çš„åœ°å€éƒ½æ¯”è¾ƒå°ã€‚

ç³»ç»Ÿè°ƒç”¨æ—¶ä¼šæœ‰å¤§é‡çŠ¶æ€çš„å˜æ›´ï¼Œå…¶ä¸­æœ€é‡è¦çš„å°±æ˜¯å½“å‰çš„`page table`ã€‚æˆ‘ä»¬å¯ä»¥æŸ¥çœ‹**STAP**å¯„å­˜å™¨ï¼š

```bash
(gdb) print/x $satp
$2 = 0x0
```

`0x0`è¡¨æ˜åˆ†é¡µåŠŸèƒ½æœªå¯ç”¨ï¼ŒCPUå½“å‰å¤„äºç›´æ¥ç‰©ç†åœ°å€è®¿é—®æ¨¡å¼ï¼Œæœªå¯ç”¨è™šæ‹Ÿå†…å­˜ã€‚

æˆ‘ä»¬å¯ä»¥åœ¨QEMUä¸­æ‰“å°å½“å‰çš„`page table`ï¼Œåœ¨QEMUç•Œé¢è¾“å…¥`ctrl a + c`è¿›å…¥QEMUçš„`console`ï¼Œç„¶åè¾“å…¥`info mem`å¯ä»¥æ‰“å°å®Œæ•´çš„`page table`ã€‚

> è¿™é‡Œæ‰“å°çš„æ˜¯`kernel page table`ï¼Œä½†è€å¸ˆè¿™é‡Œåœ¨ç”¨æˆ·ç©ºé—´ğŸ¤”ï¼Œä¸çŸ¥é“æ˜¯ä¸æ˜¯è°ƒè¯•æ¨¡å¼çš„åŸå› ï¼Œæˆ–è€…æ˜¯æ˜¯åé¢`xv6`ä¿®æ”¹è¿‡ï¼Œè€ƒè™‘åˆ°`csrrw`é‚£ä¸ªåœ°æ–¹ä¹Ÿä¸ä¸€æ ·ã€‚

```bash
xv6 kernel is booting

hart 2 starting
hart 1 starting
init: starting sh
QEMU 7.2.0 monitor - type 'help' for more information
(qemu) info mem
vaddr            paddr            size             attr
---------------- ---------------- ---------------- -------
000000000c000000 000000000c000000 0000000000001000 rw---ad
000000000c001000 000000000c001000 0000000000001000 rw-----
000000000c002000 000000000c002000 0000000000001000 rw---ad
000000000c003000 000000000c003000 00000000001fd000 rw-----
000000000c200000 000000000c200000 0000000000001000 rw-----
000000000c201000 000000000c201000 0000000000001000 rw---ad
000000000c202000 000000000c202000 0000000000001000 rw-----
000000000c203000 000000000c203000 0000000000001000 rw---ad
000000000c204000 000000000c204000 0000000000001000 rw-----
000000000c205000 000000000c205000 0000000000001000 rw---ad
000000000c206000 000000000c206000 00000000001fa000 rw-----
000000000c400000 000000000c400000 0000000000200000 rw-----
000000000c600000 000000000c600000 0000000000200000 rw-----
000000000c800000 000000000c800000 0000000000200000 rw-----
000000000ca00000 000000000ca00000 0000000000200000 rw-----
000000000cc00000 000000000cc00000 0000000000200000 rw-----
000000000ce00000 000000000ce00000 0000000000200000 rw-----
000000000d000000 000000000d000000 0000000000200000 rw-----
000000000d200000 000000000d200000 0000000000200000 rw-----
000000000d400000 000000000d400000 0000000000200000 rw-----
000000000d600000 000000000d600000 0000000000200000 rw-----
000000000d800000 000000000d800000 0000000000200000 rw-----
000000000da00000 000000000da00000 0000000000200000 rw-----
000000000dc00000 000000000dc00000 0000000000200000 rw-----
000000000de00000 000000000de00000 0000000000200000 rw-----
000000000e000000 000000000e000000 0000000000200000 rw-----
000000000e200000 000000000e200000 0000000000200000 rw-----
000000000e400000 000000000e400000 0000000000200000 rw-----
000000000e600000 000000000e600000 0000000000200000 rw-----
000000000e800000 000000000e800000 0000000000200000 rw-----
000000000ea00000 000000000ea00000 0000000000200000 rw-----
000000000ec00000 000000000ec00000 0000000000200000 rw-----
000000000ee00000 000000000ee00000 0000000000200000 rw-----
000000000f000000 000000000f000000 0000000000200000 rw-----
000000000f200000 000000000f200000 0000000000200000 rw-----
000000000f400000 000000000f400000 0000000000200000 rw-----
000000000f600000 000000000f600000 0000000000200000 rw-----
000000000f800000 000000000f800000 0000000000200000 rw-----
000000000fa00000 000000000fa00000 0000000000200000 rw-----
000000000fc00000 000000000fc00000 0000000000200000 rw-----
000000000fe00000 000000000fe00000 0000000000200000 rw-----
0000000010000000 0000000010000000 0000000000002000 rw---ad
0000000080000000 0000000080000000 0000000000006000 r-x--a-
0000000080006000 0000000080006000 0000000000001000 r-x----
0000000080007000 0000000080007000 0000000000015000 rw---ad
000000008001c000 000000008001c000 0000000000004000 rw-----
0000000080020000 0000000080020000 0000000000001000 rw---ad
0000000080021000 0000000080021000 00000000001df000 rw-----
0000000080200000 0000000080200000 0000000000200000 rw-----
0000000080400000 0000000080400000 0000000000200000 rw-----
0000000080600000 0000000080600000 0000000000200000 rw-----
0000000080800000 0000000080800000 0000000000200000 rw-----
0000000080a00000 0000000080a00000 0000000000200000 rw-----
0000000080c00000 0000000080c00000 0000000000200000 rw-----
0000000080e00000 0000000080e00000 0000000000200000 rw-----
0000000081000000 0000000081000000 0000000000200000 rw-----
0000000081200000 0000000081200000 0000000000200000 rw-----
0000000081400000 0000000081400000 0000000000200000 rw-----
0000000081600000 0000000081600000 0000000000200000 rw-----
0000000081800000 0000000081800000 0000000000200000 rw-----
0000000081a00000 0000000081a00000 0000000000200000 rw-----
0000000081c00000 0000000081c00000 0000000000200000 rw-----
0000000081e00000 0000000081e00000 0000000000200000 rw-----
0000000082000000 0000000082000000 0000000000200000 rw-----
0000000082200000 0000000082200000 0000000000200000 rw-----
0000000082400000 0000000082400000 0000000000200000 rw-----
0000000082600000 0000000082600000 0000000000200000 rw-----
0000000082800000 0000000082800000 0000000000200000 rw-----
0000000082a00000 0000000082a00000 0000000000200000 rw-----
0000000082c00000 0000000082c00000 0000000000200000 rw-----
0000000082e00000 0000000082e00000 0000000000200000 rw-----
0000000083000000 0000000083000000 0000000000200000 rw-----
0000000083200000 0000000083200000 0000000000200000 rw-----
0000000083400000 0000000083400000 0000000000200000 rw-----
0000000083600000 0000000083600000 0000000000200000 rw-----
0000000083800000 0000000083800000 0000000000200000 rw-----
0000000083a00000 0000000083a00000 0000000000200000 rw-----
0000000083c00000 0000000083c00000 0000000000200000 rw-----
0000000083e00000 0000000083e00000 0000000000200000 rw-----
0000000084000000 0000000084000000 0000000000200000 rw-----
0000000084200000 0000000084200000 0000000000200000 rw-----
0000000084400000 0000000084400000 0000000000200000 rw-----
0000000084600000 0000000084600000 0000000000200000 rw-----
0000000084800000 0000000084800000 0000000000200000 rw-----
0000000084a00000 0000000084a00000 0000000000200000 rw-----
0000000084c00000 0000000084c00000 0000000000200000 rw-----
0000000084e00000 0000000084e00000 0000000000200000 rw-----
0000000085000000 0000000085000000 0000000000200000 rw-----
0000000085200000 0000000085200000 0000000000200000 rw-----
0000000085400000 0000000085400000 0000000000200000 rw-----
0000000085600000 0000000085600000 0000000000200000 rw-----
0000000085800000 0000000085800000 0000000000200000 rw-----
0000000085a00000 0000000085a00000 0000000000200000 rw-----
0000000085c00000 0000000085c00000 0000000000200000 rw-----
0000000085e00000 0000000085e00000 0000000000200000 rw-----
0000000086000000 0000000086000000 0000000000200000 rw-----
0000000086200000 0000000086200000 0000000000200000 rw-----
0000000086400000 0000000086400000 0000000000200000 rw-----
0000000086600000 0000000086600000 0000000000200000 rw-----
0000000086800000 0000000086800000 0000000000200000 rw-----
0000000086a00000 0000000086a00000 0000000000200000 rw-----
0000000086c00000 0000000086c00000 0000000000200000 rw-----
0000000086e00000 0000000086e00000 0000000000200000 rw-----
0000000087000000 0000000087000000 0000000000200000 rw-----
0000000087200000 0000000087200000 0000000000200000 rw-----
0000000087400000 0000000087400000 0000000000200000 rw-----
0000000087600000 0000000087600000 0000000000200000 rw-----
0000000087800000 0000000087800000 0000000000200000 rw-----
0000000087a00000 0000000087a00000 0000000000200000 rw-----
0000000087c00000 0000000087c00000 0000000000200000 rw-----
0000000087e00000 0000000087e00000 0000000000138000 rw-----
0000000087f38000 0000000087f38000 0000000000001000 rw---ad
0000000087f39000 0000000087f39000 0000000000001000 rw---a-
0000000087f3a000 0000000087f3a000 000000000000d000 rw---ad
0000000087f47000 0000000087f47000 0000000000001000 rw---a-
0000000087f48000 0000000087f48000 0000000000012000 rw---ad
0000000087f5a000 0000000087f5a000 00000000000a6000 rw-----
0000003ffff7f000 0000000087f5a000 0000000000001000 rw-----
0000003ffff81000 0000000087f5b000 0000000000001000 rw-----
0000003ffff83000 0000000087f5c000 0000000000001000 rw-----
0000003ffff85000 0000000087f5d000 0000000000001000 rw-----
0000003ffff87000 0000000087f5e000 0000000000001000 rw-----
0000003ffff89000 0000000087f5f000 0000000000001000 rw-----
0000003ffff8b000 0000000087f60000 0000000000001000 rw-----
0000003ffff8d000 0000000087f61000 0000000000001000 rw-----
0000003ffff8f000 0000000087f62000 0000000000001000 rw-----
0000003ffff91000 0000000087f63000 0000000000001000 rw-----
0000003ffff93000 0000000087f64000 0000000000001000 rw-----
0000003ffff95000 0000000087f65000 0000000000001000 rw-----
0000003ffff97000 0000000087f66000 0000000000001000 rw-----
0000003ffff99000 0000000087f67000 0000000000001000 rw-----
0000003ffff9b000 0000000087f68000 0000000000001000 rw-----
0000003ffff9d000 0000000087f69000 0000000000001000 rw-----
0000003ffff9f000 0000000087f6a000 0000000000001000 rw-----
0000003ffffa1000 0000000087f6b000 0000000000001000 rw-----
0000003ffffa3000 0000000087f6c000 0000000000001000 rw-----
0000003ffffa5000 0000000087f6d000 0000000000001000 rw-----
0000003ffffa7000 0000000087f6e000 0000000000001000 rw-----
0000003ffffa9000 0000000087f6f000 0000000000001000 rw-----
0000003ffffab000 0000000087f70000 0000000000001000 rw-----
0000003ffffad000 0000000087f71000 0000000000001000 rw-----
0000003ffffaf000 0000000087f72000 0000000000001000 rw-----
0000003ffffb1000 0000000087f73000 0000000000001000 rw-----
0000003ffffb3000 0000000087f74000 0000000000001000 rw-----
0000003ffffb5000 0000000087f75000 0000000000001000 rw-----
0000003ffffb7000 0000000087f76000 0000000000001000 rw-----
0000003ffffb9000 0000000087f77000 0000000000001000 rw-----
0000003ffffbb000 0000000087f78000 0000000000001000 rw-----
0000003ffffbd000 0000000087f79000 0000000000001000 rw-----
0000003ffffbf000 0000000087f7a000 0000000000001000 rw-----
0000003ffffc1000 0000000087f7b000 0000000000001000 rw-----
0000003ffffc3000 0000000087f7c000 0000000000001000 rw-----
0000003ffffc5000 0000000087f7d000 0000000000001000 rw-----
0000003ffffc7000 0000000087f7e000 0000000000001000 rw-----
0000003ffffc9000 0000000087f7f000 0000000000001000 rw-----
0000003ffffcb000 0000000087f80000 0000000000001000 rw-----
0000003ffffcd000 0000000087f81000 0000000000001000 rw-----
0000003ffffcf000 0000000087f82000 0000000000001000 rw-----
0000003ffffd1000 0000000087f83000 0000000000001000 rw-----
0000003ffffd3000 0000000087f84000 0000000000001000 rw-----
0000003ffffd5000 0000000087f85000 0000000000001000 rw-----
0000003ffffd7000 0000000087f86000 0000000000001000 rw-----
0000003ffffd9000 0000000087f87000 0000000000001000 rw-----
0000003ffffdb000 0000000087f88000 0000000000001000 rw-----
0000003ffffdd000 0000000087f89000 0000000000001000 rw-----
0000003ffffdf000 0000000087f8a000 0000000000001000 rw-----
0000003ffffe1000 0000000087f8b000 0000000000001000 rw-----
0000003ffffe3000 0000000087f8c000 0000000000001000 rw-----
0000003ffffe5000 0000000087f8d000 0000000000001000 rw-----
0000003ffffe7000 0000000087f8e000 0000000000001000 rw-----
0000003ffffe9000 0000000087f8f000 0000000000001000 rw-----
0000003ffffeb000 0000000087f90000 0000000000001000 rw-----
0000003ffffed000 0000000087f91000 0000000000001000 rw-----
0000003ffffef000 0000000087f92000 0000000000001000 rw-----
0000003fffff1000 0000000087f93000 0000000000001000 rw-----
0000003fffff3000 0000000087f94000 0000000000001000 rw-----
0000003fffff5000 0000000087f95000 0000000000001000 rw-----
0000003fffff7000 0000000087f96000 0000000000001000 rw-----
0000003fffff9000 0000000087f97000 0000000000001000 rw-----
0000003fffffb000 0000000087f98000 0000000000001000 rw---ad
0000003fffffd000 0000000087f99000 0000000000001000 rw---ad
0000003ffffff000 0000000080006000 0000000000001000 r-x--a-
```

`attr`åˆ—æ˜¯PTEçš„æ ‡å¿—ä½ã€‚`rwx`è¡¨ç¤ºè¿™ä¸ª`page`å¯è¯»å¯å†™ä¹Ÿå¯æ‰§è¡ŒæŒ‡ä»¤ï¼Œ`u`è¡¨ç¤ºPTE_Uæ˜¯å¦è¢«è®¾ç½®ï¼Œå†ç„¶åæ˜¯`Global`æ ‡å¿—ä½ï¼Œ`a`è¡¨æ˜PTEæ˜¯å¦è¢«ä½¿ç”¨è¿‡ï¼Œ`d`è¡¨æ˜æ˜¯å¦è¢«å†™è¿‡ã€‚

å¦å¤–ï¼Œæœ€åä¸¤æ¡PTEçš„è™šæ‹Ÿåœ°å€éå¸¸å¤§ï¼Œæ¥è¿‘è™šæ‹Ÿåœ°å€çš„é¡¶ç«¯ï¼Œåˆ†åˆ«æ˜¯`trapframe`å’Œ`trampoline`ã€‚

æ¥ä¸‹æ¥åœ¨`Shell`ä¸­æ‰“å°å‡º`write`çš„å†…å®¹ï¼š

```bash
(gdb) x/3i 0xc12
=> 0xc12:       li      a7,16
   0xc14:       ecall
   0xc18:       ret
```

---

## ECALLæŒ‡ä»¤ä¹‹åçš„çŠ¶æ€

ç°åœ¨æ‰§è¡Œ`ecall`æŒ‡ä»¤ï¼š

```bash
(gdb) stepi
0x0000000000000c14 in ?? ()
(gdb) print $pc
$3 = (void (*)()) 0xc14
```

çœ‹ä¸€ä¸‹æ¥ä¸‹æ¥è¦è¿è¡Œçš„æŒ‡ä»¤ï¼š

```bash
(gdb) x/6i 0xc14
=> 0xc14:       ecall
   0xc18:       ret
   0xc1a:       li      a7,21
   0xc1c:       ecall
   0xc20:       ret
   0xc22:       li      a7,6
```

`ecall`ä¼šå°†ä»£ç ä»`user mode`æ”¹åˆ°`supervisor mode`ï¼Œç„¶åå°†ç¨‹åºè®¡æ•°å™¨çš„å€¼ä¿å­˜åˆ°SEPCå¯„å­˜å™¨ï¼Œå†è·³è½¬åˆ°STVECå¯„å­˜å™¨æŒ‡å‘çš„æŒ‡ä»¤ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬è¿˜éœ€è¦è¿›è¡Œï¼š

- ä¿å­˜32ä¸ªç”¨æˆ·å¯„å­˜å™¨çš„å†…å®¹ï¼›

- ä»`user page table`åˆ‡æ¢åˆ°`kernel page table`ï¼›

- éœ€è¦å°†Stack Pointerå¯„å­˜å™¨æŒ‡å‘ä¸€ä¸ª`kernel stack`ï¼Œç»™Cä»£ç æä¾›æ ˆï¼›

- éœ€è¦è·³è½¬åˆ°å†…æ ¸ä¸­Cä»£ç çš„ç‰¹å®šä½ç½®ã€‚

åŸºäºRISC-Vçš„è®¾è®¡ç†å¿µï¼Œè¿™äº›äº¤ç»™è½¯ä»¶æ¥å®Œæˆã€‚

> RISC-Vè®¤ä¸ºï¼Œ`ecall`åªå®Œæˆå°½é‡å°‘ä¸”å¿…é¡»å®Œæˆçš„å·¥ä½œï¼Œå…¶ä»–éƒ½äº¤ç»™è½¯ä»¶å®Œæˆã€‚è¿™æ ·å¯ä»¥ä¸ºè½¯ä»¶å’Œæ“ä½œç³»ç»Ÿç¨‹åºå‘˜æä¾›æœ€å¤§çš„çµæ´»æ€§ã€‚

---

## uservecå‡½æ•°

ç°åœ¨ç¨‹åºä½äº`trampoline page`çš„èµ·å§‹å¤„ï¼Œä¹Ÿæ˜¯`uservec`å‡½æ•°çš„å¼€å§‹ã€‚ç”±äºRISC-Vä¸­`supervisor mode`ä¸‹çš„ä»£ç ä¸å…è®¸ç›´æ¥è®¿é—®ç‰©ç†å†…å­˜ï¼Œå› æ­¤åœ¨æ‹·è´ç”¨æˆ·å¯„å­˜å™¨æ—¶ï¼Œåªèƒ½ä½¿ç”¨`page table`è€Œä¸èƒ½ç›´æ¥ä½¿ç”¨ç‰©ç†å†…å­˜ã€‚å¦ä¸€ç§æ€è·¯æ˜¯åœ¨`supervisor mode`ä¸‹æ›´æ”¹SATPå¯„å­˜å™¨ï¼Œä½¿å…¶æŒ‡å‘`kernel page table`ï¼Œä½†æ˜¯åœ¨å½“å‰ä½ç½®æˆ‘ä»¬å¹¶ä¸çŸ¥é“`kernel page table`çš„åœ°å€ã€‚

`xv6`çš„å®ç°åŒ…å«ä¸¤ä¸ªéƒ¨åˆ†ã€‚

ç¬¬ä¸€ä¸ªéƒ¨åˆ†é‡Œï¼Œ`xv6`åœ¨æ¯ä¸ª`user page table`æ˜ å°„äº†`trapframe page`ï¼Œè¿™æ˜¯ç”±`kernel`è®¾ç½®çš„ï¼Œæ˜ å°„æŒ‡å‘ä¸€ä¸ªå¯ä»¥ç”¨æ¥å­˜æ”¾è¿™ä¸ªè¿›ç¨‹çš„ç”¨æˆ·å¯„å­˜å™¨çš„å†…å­˜ä½ç½®ï¼Œè¿™ä¸ªä½ç½®çš„è™šæ‹Ÿåœ°å€æ˜¯å›ºå®šçš„ã€‚

```c
// per-process data for the trap handling code in trampoline.S.
// sits in a page by itself just under the trampoline page in the
// user page table. not specially mapped in the kernel page table.
// uservec in trampoline.S saves user registers in the trapframe,
// then initializes registers from the trapframe's
// kernel_sp, kernel_hartid, kernel_satp, and jumps to kernel_trap.
// usertrapret() and userret in trampoline.S set up
// the trapframe's kernel_*, restore user registers from the
// trapframe, switch to the user page table, and enter user space.
// the trapframe includes callee-saved user registers like s0-s11 because the
// return-to-user path via usertrapret() doesn't return through
// the entire kernel call stack.
struct trapframe {
  /*   0 */ uint64 kernel_satp;   // kernel page table
  /*   8 */ uint64 kernel_sp;     // top of process's kernel stack
  /*  16 */ uint64 kernel_trap;   // usertrap()
  /*  24 */ uint64 epc;           // saved user program counter
  /*  32 */ uint64 kernel_hartid; // saved kernel tp
  /*  40 */ uint64 ra;
  /*  48 */ uint64 sp;
  /*  56 */ uint64 gp;
  /*  64 */ uint64 tp;
  /*  72 */ uint64 t0;
  /*  80 */ uint64 t1;
  /*  88 */ uint64 t2;
  /*  96 */ uint64 s0;
  /* 104 */ uint64 s1;
  /* 112 */ uint64 a0;
  /* 120 */ uint64 a1;
  /* 128 */ uint64 a2;
  /* 136 */ uint64 a3;
  /* 144 */ uint64 a4;
  /* 152 */ uint64 a5;
  /* 160 */ uint64 a6;
  /* 168 */ uint64 a7;
  /* 176 */ uint64 s2;
  /* 184 */ uint64 s3;
  /* 192 */ uint64 s4;
  /* 200 */ uint64 s5;
  /* 208 */ uint64 s6;
  /* 216 */ uint64 s7;
  /* 224 */ uint64 s8;
  /* 232 */ uint64 s9;
  /* 240 */ uint64 s10;
  /* 248 */ uint64 s11;
  /* 256 */ uint64 t3;
  /* 264 */ uint64 t4;
  /* 272 */ uint64 t5;
  /* 280 */ uint64 t6;
};
```

ä»¥ä¸Šå°±æ˜¯`xv6`åœ¨`tramframe page`ä¸­å­˜æ”¾çš„å†…å®¹ã€‚æœ€å¼€å§‹çš„äº”ä¸ªæ•°æ®æ˜¯å†…æ ¸é¢„å…ˆå­˜æ”¾çš„æ•°æ®ï¼Œå¦‚ç¬¬ä¸€ä¸ªä¿å­˜äº†`kernel page table`çš„åœ°å€ï¼Œè¿™æ˜¯`trap`å¤„ç†ä»£ç å°†è¦åŠ è½½åˆ°SATPå¯„å­˜å™¨ä¸­çš„æ•°ã€‚

å¦ä¸€éƒ¨åˆ†æ˜¯SSCRATCHå¯„å­˜å™¨ã€‚åœ¨è¿›å…¥åˆ°`user page`ä¹‹å‰ï¼Œå†…æ ¸ä¼šå°†`trapframe page`çš„åœ°å€ä¿å­˜åœ¨è¿™ä¸ªå¯„å­˜å™¨ä¸­ã€‚

---

## usertrapå‡½æ•°

`usertrap`é¦–å…ˆæ›´æ”¹STVECå¯„å­˜å™¨ï¼Œå°†å…¶æŒ‡å‘`kernelvec`å˜é‡ï¼Œè¿™æ˜¯å†…æ ¸ç©ºé—´`trap`å¤„ç†ä»£ç çš„ä½ç½®ï¼›ç„¶åä¿å­˜ç”¨æˆ·ç¨‹åºè®¡æ•°å™¨åˆ°SEPCå¯„å­˜å™¨ä¸­ï¼›æ¥ä¸‹æ¥æ ¹æ®è§¦å‘`trap`çš„åŸå› ï¼Œè®¾ç½®SCAUSEå¯„å­˜å™¨çš„å€¼ï¼›ç„¶åå°±æ˜¯ä¸€äº›å¤„ç†æ“ä½œï¼Œåœ¨Chapter4ä¸­æœ‰ä»‹ç»ã€‚

---

## usertrapretå‡½æ•°

`usertrap`æœ€åä¼šè°ƒç”¨`usertrapret`å‡½æ•°æ¥è®¾ç½®è¿”å›ç”¨æˆ·ç©ºé—´å‰å†…æ ¸è¦åšçš„å·¥ä½œã€‚å®ƒé¦–å…ˆä¼šå…³é—­ä¸­æ–­ï¼Œå› ä¸ºæˆ‘ä»¬è¦æ›´æ–°STVECå¯„å­˜å™¨æŒ‡å‘ç”¨æˆ·ç©ºé—´çš„`trap`å¤„ç†ä»£ç ï¼›ç„¶åè®¾ç½®STVECå¯„å­˜å™¨æŒ‡å‘`trampoline`ä»£ç ï¼Œè¿™é‡Œæœ€ç»ˆä¼šæ‰§è¡Œ`sret`æŒ‡ä»¤è¿”å›ç”¨æˆ·ç©ºé—´ï¼Œè¯¥æŒ‡ä»¤åˆä¼šé‡æ–°æ‰“å¼€ä¸­æ–­ï¼›æ¥ä¸‹æ¥ä¼šå¡«å……ä¸€äº›`trapframe`çš„å†…å®¹ï¼ŒåŒ…æ‹¬`kernel page table`çš„æŒ‡é’ˆã€å‚¨å­˜äº†å½“å‰ç”¨æˆ·è¿›ç¨‹çš„`kernel stack`ã€å‚¨å­˜äº†`usertrap`å‡½æ•°çš„æŒ‡é’ˆã€ä»`tp`å¯„å­˜å™¨ä¸­è¯»å–çš„CPUæ ¸ç¼–å·ã€‚

`sret`æŒ‡ä»¤ä¼šå°†ç¨‹åºè®¡æ•°å™¨è®¾ç½®æˆSEPCå¯„å­˜å™¨çš„å€¼ï¼Œå¹¶æ ¹æ®`user page table`åœ°å€ç”Ÿæˆç›¸åº”çš„SATPå€¼ï¼Œè¿™æ ·åœ¨è¿”å›ç”¨æˆ·ç©ºé—´æ—¶æ‰èƒ½å®Œæˆ`page table`çš„åˆ‡æ¢ã€‚

---

## userretå‡½æ•°

ç¬¬ä¸€æ­¥æ˜¯åˆ‡æ¢`page table`ï¼Œåˆ‡æ¢åˆ°`user page table`ï¼›ç„¶åå°†SSCRATCHå¯„å­˜å™¨æ¢å¤æˆä¿å­˜å¥½çš„ç”¨æˆ·çš„`a0`å¯„å­˜å™¨ï¼Œè¿™é‡Œ`a0`æ˜¯`trapframe`çš„åœ°å€ã€‚

`sret`æ˜¯åœ¨`kernel`ä¸­çš„æœ€åä¸€æ¡æŒ‡ä»¤ï¼Œæ‰§è¡Œå®Œåå°±ä¼šå›åˆ°`user mode`ã€‚
